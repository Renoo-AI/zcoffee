<!DOCTYPE html>
<html lang="fr" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin | ZCOFFEE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f0f0f;
            --text: #f5f5f5;
            --card-bg: #1a1a1a;
            --card-border: rgba(255, 255, 255, 0.05);
            --nav-bg: rgba(15, 15, 15, 0.8);
            --input-bg: #262626;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            letter-spacing: -0.01em;
        }

        .pro-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .pro-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            border-color: rgba(180, 140, 104, 0.3);
        }

        .glass-nav {
            background: var(--nav-bg);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--card-border);
        }

        input,
        select {
            background: var(--input-bg) !important;
            border: 1px solid var(--card-border) !important;
            color: var(--text) !important;
            transition: all 0.3s ease;
        }

        input:focus,
        select:focus {
            background: var(--card-bg) !important;
            border-color: #b48c68 !important;
            outline: none !important;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade {
            animation: fadeIn 0.6s ease forwards;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .toast {
            animation: slideIn 0.3s ease-out;
        }

        .toast.hide {
            animation: slideOut 0.3s ease-out;
        }

        .unavailable {
            opacity: 0.5;
            position: relative;
        }

        .unavailable::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(45deg,
                    transparent,
                    transparent 10px,
                    rgba(255, 0, 0, 0.05) 10px,
                    rgba(255, 0, 0, 0.05) 20px);
            pointer-events: none;
        }
    </style>
</head>

<body class="min-h-screen">
    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-24 right-6 z-[200] flex flex-col gap-3"></div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="hidden fixed inset-0 z-[150] flex items-center justify-center p-6">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeConfirmModal()"></div>
        <div class="pro-card w-full max-w-md rounded-3xl p-8 relative z-10 animate-fade">
            <div class="text-center mb-6">
                <div id="confirmIcon"
                    class="w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center text-3xl"></div>
                <h3 id="confirmTitle" class="text-xl font-bold mb-2 text-white"></h3>
                <p id="confirmMessage" class="text-sm opacity-60 text-white"></p>
            </div>
            <div class="flex gap-3">
                <button onclick="closeConfirmModal()"
                    class="flex-1 py-3 rounded-xl border border-white/10 text-white hover:bg-white/5 transition-all font-bold text-xs uppercase">Annuler</button>
                <button id="confirmButton"
                    class="flex-1 py-3 rounded-xl bg-red-500 text-white hover:bg-red-600 transition-all font-bold text-xs uppercase">Confirmer</button>
            </div>
        </div>
    </div>

    <div id="body-content" class="hidden">
        <!-- Navigation -->
        <nav class="glass-nav fixed top-0 w-full z-50 px-6 py-4">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div
                        class="w-10 h-10 bg-white text-black rounded-xl flex items-center justify-center font-bold text-xl">
                        Z</div>
                    <div>
                        <h1 class="font-bold text-sm uppercase tracking-widest text-white">Dashboard</h1>
                        <p id="userEmail" class="text-[10px] opacity-40 font-bold uppercase tracking-tight text-white">
                        </p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="logout()"
                        class="px-5 py-2.5 rounded-xl bg-white/5 border border-white/10 text-xs font-bold uppercase tracking-widest text-white hover:bg-red-900/40 hover:text-red-500 transition-all">DÃ©connexion</button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto pt-32 pb-20 px-6">
            <!-- Header with Search -->
            <div class="mb-8 animate-fade">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-6">
                    <div>
                        <h2 class="text-4xl font-bold tracking-tight mb-2 text-white">Gestion du Menu</h2>
                        <p class="text-sm opacity-40 font-bold uppercase tracking-widest text-white">ContrÃ´le de la
                            carte digitale</p>
                    </div>
                    <div class="flex flex-wrap gap-3">
                        <button onclick="openModal()"
                            class="px-6 py-3 rounded-xl bg-white text-black text-xs font-bold uppercase tracking-widest hover:scale-105 transition-all flex items-center gap-2">
                            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5"
                                viewBox="0 0 24 24">
                                <path d="M12 4v16m8-8H4" />
                            </svg>
                            Ajouter
                        </button>
                        <button onclick="confirmClearMenu()"
                            class="px-6 py-3 rounded-xl bg-white/5 border border-white/10 text-white text-xs font-bold uppercase tracking-widest hover:bg-red-900/20 hover:text-red-500 transition-all flex items-center gap-2">
                            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"
                                viewBox="0 0 24 24">
                                <path
                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            Vider
                        </button>
                        <button onclick="confirmRestoreDefaults()"
                            class="px-6 py-3 rounded-xl bg-white/5 border border-white text-white text-xs font-bold uppercase tracking-widest hover:bg-white hover:text-black transition-all flex items-center gap-2">
                            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"
                                viewBox="0 0 24 24">
                                <path
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            Restaurer Menu
                        </button>
                    </div>
                </div>

                <!-- Search and Filters -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2">
                        <input type="text" id="searchInput" placeholder="ğŸ” Rechercher par nom (FR/AR) ou catÃ©gorie..."
                            class="w-full p-4 rounded-xl outline-none">
                    </div>
                    <select id="categoryFilter" class="p-4 rounded-xl outline-none">
                        <option value="">Toutes les catÃ©gories</option>
                    </select>
                </div>

                <div class="flex gap-3 mt-4">
                    <button id="filterAll" onclick="setAvailabilityFilter('all')"
                        class="px-4 py-2 rounded-lg bg-white/10 text-white text-xs font-bold uppercase border border-white/20 hover:bg-white/20 transition-all">Tous</button>
                    <button id="filterAvailable" onclick="setAvailabilityFilter('available')"
                        class="px-4 py-2 rounded-lg bg-white/5 text-white text-xs font-bold uppercase border border-white/10 hover:bg-white/10 transition-all">ğŸŸ¢
                        Disponibles</button>
                    <button id="filterUnavailable" onclick="setAvailabilityFilter('unavailable')"
                        class="px-4 py-2 rounded-lg bg-white/5 text-white text-xs font-bold uppercase border border-white/10 hover:bg-white/10 transition-all">ğŸ”´
                        Indisponibles</button>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-12 animate-fade"
                style="animation-delay: 0.1s">
                <div class="pro-card p-6 rounded-2xl">
                    <p class="text-[9px] font-bold uppercase tracking-[0.2em] opacity-30 mb-1 text-white">Total</p>
                    <h3 id="statTotal" class="text-2xl font-bold text-white">0</h3>
                </div>
                <div class="pro-card p-6 rounded-2xl">
                    <p class="text-[9px] font-bold uppercase tracking-[0.2em] opacity-30 mb-1 text-white">Disponibles
                    </p>
                    <h3 id="statAvailable" class="text-2xl font-bold text-green-400">0</h3>
                </div>
                <div class="pro-card p-6 rounded-2xl">
                    <p class="text-[9px] font-bold uppercase tracking-[0.2em] opacity-30 mb-1 text-white">Prix Moyen</p>
                    <h3 id="statAvgPrice" class="text-2xl font-bold text-[#b48c68]">0</h3>
                </div>
                <div class="pro-card p-6 rounded-2xl">
                    <p class="text-[9px] font-bold uppercase tracking-[0.2em] opacity-30 mb-1 text-white">Prix Min</p>
                    <h3 id="statMinPrice" class="text-2xl font-bold text-blue-400">0</h3>
                </div>
                <div class="pro-card p-6 rounded-2xl">
                    <p class="text-[9px] font-bold uppercase tracking-[0.2em] opacity-30 mb-1 text-white">Prix Max</p>
                    <h3 id="statMaxPrice" class="text-2xl font-bold text-purple-400">0</h3>
                </div>
                <div class="pro-card p-6 rounded-2xl">
                    <p class="text-[9px] font-bold uppercase tracking-[0.2em] opacity-30 mb-1 text-white">CatÃ©gories</p>
                    <h3 id="statCategories" class="text-2xl font-bold text-orange-400">0</h3>
                </div>
            </div>

            <!-- Grid -->
            <div id="loading" class="flex justify-center py-20">
                <div class="w-8 h-8 border-4 border-white/5 border-t-white rounded-full animate-spin"></div>
            </div>
            <div id="menuList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-fade"
                style="animation-delay: 0.2s"></div>
            <div id="noResults" class="hidden text-center py-20">
                <p class="text-white/40 font-bold uppercase text-sm">Aucun rÃ©sultat trouvÃ©</p>
            </div>
        </main>
    </div>

    <!-- Modal Article -->
    <div id="modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-6">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="pro-card w-full max-w-xl rounded-3xl p-10 relative animate-fade z-10">
            <h3 id="modalTitle" class="text-2xl font-bold mb-8 text-white">Nouvel Article</h3>
            <form id="itemForm" class="space-y-6">
                <input type="hidden" id="editId">
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold uppercase tracking-widest opacity-40 text-white">CatÃ©gorie
                            (FR)</label>
                        <input type="text" id="category" list="categoryList" class="w-full p-4 rounded-xl outline-none"
                            required placeholder="Ex: CafÃ©s, Jus...">
                        <datalist id="categoryList"></datalist>
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold uppercase tracking-widest opacity-40 text-white">CatÃ©gorie
                            (AR)</label>
                        <input type="text" id="categoryAr" list="categoryListAr"
                            class="w-full p-4 rounded-xl outline-none" dir="rtl" placeholder="Ø§Ù„ÙØ¦Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©">
                        <datalist id="categoryListAr"></datalist>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold uppercase tracking-widest opacity-40 text-white">Nom
                            (FR)</label>
                        <input type="text" id="nameFr" class="w-full p-4 rounded-xl outline-none" required
                            placeholder="Nom de l'article">
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold uppercase tracking-widest opacity-40 text-white">Nom
                            (AR)</label>
                        <input type="text" id="nameAr" class="w-full p-4 rounded-xl outline-none" dir="rtl" required
                            placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold uppercase tracking-widest opacity-40 text-white">Prix
                            (DT)</label>
                        <input type="number" id="price" step="0.1" class="w-full p-4 rounded-xl outline-none" required
                            placeholder="0.0">
                    </div>
                    <div class="space-y-2">
                        <label
                            class="text-[10px] font-bold uppercase tracking-widest opacity-40 text-white">DisponibilitÃ©</label>
                        <select id="available" class="w-full p-4 rounded-xl outline-none">
                            <option value="true">ğŸŸ¢ Disponible</option>
                            <option value="false">ğŸ”´ Indisponible</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-3 pt-6">
                    <button type="button" onclick="closeModal()"
                        class="flex-1 py-4 rounded-xl font-bold text-xs uppercase tracking-widest border border-white/10 hover:bg-white/5 transition-all text-white">Annuler</button>
                    <button type="submit" id="submitBtn"
                        class="flex-1 py-4 rounded-xl font-bold text-xs uppercase tracking-widest bg-white text-black hover:scale-[1.02] active:scale-[0.98] transition-all">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, orderBy, writeBatch, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { firebaseConfig } from "../js/firebase-config.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        try {
            await enableIndexedDbPersistence(db);
        } catch (err) {
            console.warn("Persistance non disponible", err);
        }

        // --- STATE ---
        let allItems = [];
        let currentFilter = {
            search: '',
            category: '',
            availability: 'all'
        };

        // --- TOAST NOTIFICATIONS ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                info: 'â„¹ï¸',
                warning: 'âš ï¸'
            };
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-orange-500'
            };

            toast.className = `toast ${colors[type]} text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 min-w-[300px]`;
            toast.innerHTML = `
                <span class="text-xl">${icons[type]}</span>
                <span class="font-bold text-sm flex-1">${message}</span>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('hide');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- CONFIRMATION MODAL ---
        let confirmCallback = null;

        function showConfirmModal(title, message, callback, icon = 'âš ï¸', btnText = 'Confirmer') {
            const modal = document.getElementById('confirmModal');
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmIcon').innerHTML = icon;
            document.getElementById('confirmButton').textContent = btnText;
            document.getElementById('confirmButton').onclick = () => {
                callback();
                closeConfirmModal();
            };
            confirmCallback = callback;
            modal.classList.remove('hidden');
        }

        window.closeConfirmModal = () => {
            document.getElementById('confirmModal').classList.add('hidden');
            confirmCallback = null;
        };

        window.confirmClearMenu = () => {
            showConfirmModal(
                'Vider le menu',
                'Voulez-vous vraiment supprimer TOUS les articles ? Cette action est irrÃ©versible.',
                clearMenu,
                'ğŸ—‘ï¸',
                'Tout Supprimer'
            );
        };

        window.confirmRestoreDefaults = () => {
            showConfirmModal(
                'Restaurer le menu',
                'Restaurer la liste des articles par dÃ©faut ?',
                restoreDefaults,
                'ğŸ”„',
                'Restaurer'
            );
        };

        // --- CATEGORY MAPPING ---
        const categoryMapping = {
            "CafÃ©s": "Ø§Ù„Ù‚Ù‡ÙˆØ©",
            "Boissons FraÃ®ches": "Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø¨Ø§Ø±Ø¯Ø©",
            "Viennoiseries": "Ù…Ø®Ø¨ÙˆØ²Ø§Øª",
            "ThÃ©": "Ø§Ù„Ø´Ø§ÙŠ",
            "Chicha & Girac": "Ø´ÙŠØ´Ø© ÙˆØ¬ÙŠØ±Ø§Ùƒ",
            "Eaux & Soft": "Ù…ÙŠØ§Ù‡ ÙˆÙ…Ø´Ø±ÙˆØ¨Ø§Øª ØºØ§Ø²ÙŠØ©"
        };

        const categoryMappingAr = Object.fromEntries(
            Object.entries(categoryMapping).map(([fr, ar]) => [ar, fr])
        );

        const categoryFr = document.getElementById('category');
        const categoryAr = document.getElementById('categoryAr');

        categoryFr.addEventListener('input', (e) => {
            if (categoryMapping[e.target.value]) {
                categoryAr.value = categoryMapping[e.target.value];
            }
        });

        categoryAr.addEventListener('input', (e) => {
            if (categoryMappingAr[e.target.value]) {
                categoryFr.value = categoryMappingAr[e.target.value];
            }
        });

        // --- AUTHENTICATION ---
        const isAuthenticated = sessionStorage.getItem('admin_authenticated') === 'true';
        const authTimestamp = sessionStorage.getItem('auth_timestamp');
        const SESSION_TIMEOUT = 30 * 60 * 1000;

        if (!isAuthenticated || !authTimestamp) {
            window.location.href = "../zcoffee-secret-2026.html";
        } else {
            const elapsed = Date.now() - parseInt(authTimestamp);
            if (elapsed > SESSION_TIMEOUT) {
                sessionStorage.clear();
                window.location.href = "../zcoffee-secret-2026.html";
            } else {
                document.getElementById("body-content").classList.remove("hidden");
                document.getElementById("userEmail").innerText = "Administrateur";
                loadMenu();
                sessionStorage.setItem('auth_timestamp', Date.now().toString());
            }
        }

        window.logout = () => {
            sessionStorage.clear();
            window.location.href = "../zcoffee-secret-2026.html";
        };

        // --- MODAL ---
        window.openModal = (editData = null) => {
            const modal = document.getElementById('modal');
            modal.classList.remove('hidden');
            if (editData) {
                document.getElementById('modalTitle').innerText = "Modifier Article";
                document.getElementById('editId').value = editData.id;
                document.getElementById('category').value = editData.category;
                document.getElementById('categoryAr').value = editData.categoryAr;
                document.getElementById('nameFr').value = editData.nameFr;
                document.getElementById('nameAr').value = editData.nameAr;
                document.getElementById('price').value = editData.price;
                document.getElementById('available').value = editData.available !== false ? 'true' : 'false';
            } else {
                document.getElementById('modalTitle').innerText = "Nouvel Article";
                document.getElementById('itemForm').reset();
                document.getElementById('editId').value = "";
                document.getElementById('available').value = 'true';
            }
        };

        window.closeModal = () => document.getElementById('modal').classList.add('hidden');

        // --- FILTERS ---
        document.getElementById('searchInput').addEventListener('input', (e) => {
            currentFilter.search = e.target.value.toLowerCase();
            renderFilteredMenu();
        });

        document.getElementById('categoryFilter').addEventListener('change', (e) => {
            currentFilter.category = e.target.value;
            renderFilteredMenu();
        });

        window.setAvailabilityFilter = (filter) => {
            currentFilter.availability = filter;
            document.querySelectorAll('[id^="filter"]').forEach(btn => {
                btn.classList.remove('bg-white/10', 'border-white/20');
                btn.classList.add('bg-white/5', 'border-white/10');
            });
            document.getElementById(`filter${filter.charAt(0).toUpperCase() + filter.slice(1)}`).classList.add('bg-white/10', 'border-white/20');
            renderFilteredMenu();
        };

        function renderFilteredMenu() {
            const filtered = allItems.filter(item => {
                const matchSearch = !currentFilter.search ||
                    item.nameFr.toLowerCase().includes(currentFilter.search) ||
                    item.nameAr.includes(currentFilter.search) ||
                    item.category.toLowerCase().includes(currentFilter.search);

                const matchCategory = !currentFilter.category || item.category === currentFilter.category;

                const matchAvailability = currentFilter.availability === 'all' ||
                    (currentFilter.availability === 'available' && item.available !== false) ||
                    (currentFilter.availability === 'unavailable' && item.available === false);

                return matchSearch && matchCategory && matchAvailability;
            });

            const list = document.getElementById('menuList');
            const noResults = document.getElementById('noResults');
            list.innerHTML = '';

            if (filtered.length === 0) {
                list.classList.add('hidden');
                noResults.classList.remove('hidden');
                return;
            }

            list.classList.remove('hidden');
            noResults.classList.add('hidden');

            filtered.forEach(item => {
                const card = createItemCard(item);
                list.appendChild(card);
            });
        }

        function createItemCard(data) {
            const card = document.createElement('div');
            const unavailableClass = data.available === false ? 'unavailable' : '';
            card.className = `pro-card p-6 rounded-2xl flex flex-col justify-between gap-6 ${unavailableClass}`;

            const badge = data.available !== false ?
                '<span class="text-[9px] font-bold bg-green-500/20 text-green-400 px-2 py-1 rounded-md">ğŸŸ¢ DISPO</span>' :
                '<span class="text-[9px] font-bold bg-red-500/20 text-red-400 px-2 py-1 rounded-md">ğŸ”´ INDISPO</span>';

            card.innerHTML = `
                <div>
                    <div class="flex justify-between items-start mb-4">
                        <span class="text-[8px] font-bold uppercase tracking-[0.2em] bg-[#b48c68]/10 text-[#b48c68] px-3 py-1 rounded-md">${data.category}</span>
                        <span class="text-[8px] font-bold opacity-30 uppercase text-white" dir="rtl">${data.categoryAr || ''}</span>
                    </div>
                    <h4 class="font-bold text-base mb-1 text-white">${data.nameFr}</h4>
                    <p class="text-xs font-bold opacity-30 text-white mb-2" dir="rtl">${data.nameAr}</p>
                    ${badge}
                </div>
                <div class="flex justify-between items-center pt-4 border-t border-white/5">
                    <div class="text-xl font-bold text-[#b48c68]">${data.price}<span class="text-[9px] opacity-40 ml-1 uppercase">DT</span></div>
                    <div class="flex gap-2">
                        <button onclick='toggleAvailability("${data.id}", ${data.available !== false})' class="p-3 ${data.available !== false ? 'bg-green-500/10 text-green-400' : 'bg-red-500/10 text-red-400'} border ${data.available !== false ? 'border-green-500/20' : 'border-red-500/20'} hover:scale-110 rounded-xl transition-all" title="Toggle disponibilitÃ©">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        </button>
                        <button onclick='editItem("${data.id}", ${JSON.stringify(data).replace(/"/g, "&quot;")})' class="p-3 bg-white/5 border border-white/5 text-white hover:bg-white hover:text-black rounded-xl transition-all">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                        </button>
                        <button onclick='confirmDeleteItem("${data.id}")' class="p-3 bg-red-900/20 border border-red-900/40 text-red-500 hover:bg-red-500 hover:text-white rounded-xl transition-all">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6"/></svg>
                        </button>
                    </div>
                </div>`;
            return card;
        }

        // --- LOAD MENU ---
        async function loadMenu() {
            const loading = document.getElementById('loading');
            const categoryDatalist = document.getElementById('categoryList');
            const categoryDatalistAr = document.getElementById('categoryListAr');
            const categoryFilter = document.getElementById('categoryFilter');

            loading.classList.remove('hidden');

            try {
                const q = query(collection(db, "menu"), orderBy("category"));
                const querySnapshot = await getDocs(q);
                loading.classList.add('hidden');

                allItems = [];
                const categoriesFr = new Set(["CafÃ©s", "Boissons FraÃ®ches", "Viennoiseries", "ThÃ©", "Chicha & Girac", "Eaux & Soft"]);
                const categoriesAr = new Set(["Ø§Ù„Ù‚Ù‡ÙˆØ©", "Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø¨Ø§Ø±Ø¯Ø©", "Ù…Ø®Ø¨ÙˆØ²Ø§Øª", "Ø§Ù„Ø´Ø§ÙŠ", "Ø´ÙŠØ´Ø© ÙˆØ¬ÙŠØ±Ø§Ùƒ", "Ù…ÙŠØ§Ù‡ ÙˆÙ…Ø´Ø±ÙˆØ¨Ø§Øª ØºØ§Ø²ÙŠØ©"]);

                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    allItems.push({
                        id: docSnap.id,
                        ...data,
                        price: typeof data.price === 'string' ? parseFloat(data.price) : data.price
                    });

                    if (data.category) categoriesFr.add(data.category);
                    if (data.categoryAr) categoriesAr.add(data.categoryAr);
                });

                // Update datalists
                categoryDatalist.innerHTML = '';
                Array.from(categoriesFr).sort().forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat;
                    categoryDatalist.appendChild(opt);
                });

                categoryDatalistAr.innerHTML = '';
                Array.from(categoriesAr).sort().forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat;
                    categoryDatalistAr.appendChild(opt);
                });

                // Update category filter
                categoryFilter.innerHTML = '<option value="">Toutes les catÃ©gories</option>';
                Array.from(categoriesFr).sort().forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat;
                    opt.textContent = cat;
                    categoryFilter.appendChild(opt);
                });

                // Update stats
                updateStats();
                renderFilteredMenu();
            } catch (err) {
                console.error(err);
                showToast('Erreur de chargement', 'error');
            }
        }

        /**
         * âš¡ Bolt: Single-pass stats calculation
         * Optimization: O(N) single loop instead of 7+ array iterations (filter, map, reduce).
         * Impact: Reduces CPU overhead and memory allocation for intermediate arrays.
         * Prevents potential stack overflow from spread operator on large data sets.
         */
        function updateStats() {
            let available = 0;
            let totalPrice = 0;
            let priceCount = 0;
            let minPrice = Infinity;
            let maxPrice = -Infinity;
            const categories = new Set();

            for (const item of allItems) {
                if (item.available !== false) available++;

                const price = item.price;
                if (price > 0) {
                    totalPrice += price;
                    priceCount++;
                    if (price < minPrice) minPrice = price;
                    if (price > maxPrice) maxPrice = price;
                }

                if (item.category) categories.add(item.category);
            }

            const total = allItems.length;
            const avgPrice = priceCount > 0 ? (totalPrice / priceCount).toFixed(1) : 0;
            const minPriceDisplay = priceCount > 0 ? minPrice.toFixed(1) : 0;
            const maxPriceDisplay = priceCount > 0 ? maxPrice.toFixed(1) : 0;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statAvailable').textContent = available;
            document.getElementById('statAvgPrice').textContent = avgPrice + ' DT';
            document.getElementById('statMinPrice').textContent = minPriceDisplay + ' DT';
            document.getElementById('statMaxPrice').textContent = maxPriceDisplay + ' DT';
            document.getElementById('statCategories').textContent = categories.size;
        }

        // --- CRUD OPERATIONS ---
        window.editItem = (id, data) => openModal({ id, ...data });

        window.confirmDeleteItem = (id) => {
            showConfirmModal(
                'Supprimer l\'article',
                'Voulez-vous vraiment supprimer cet article ?',
                () => deleteItem(id),
                'ğŸ—‘ï¸',
                'Supprimer'
            );
        };

        async function deleteItem(id) {
            try {
                await deleteDoc(doc(db, "menu", id));
                showToast('Article supprimÃ©', 'success');
                loadMenu();
            } catch (e) {
                showToast('Erreur de suppression', 'error');
            }
        }

        async function clearMenu() {
            try {
                const q = await getDocs(collection(db, "menu"));
                const batch = writeBatch(db);
                q.forEach(d => batch.delete(doc(db, "menu", d.id)));
                await batch.commit();
                showToast('Menu vidÃ©', 'success');
                loadMenu();
            } catch (e) {
                showToast('Erreur', 'error');
            }
        }

        window.toggleAvailability = async (id, currentStatus) => {
            try {
                await updateDoc(doc(db, "menu", id), {
                    available: !currentStatus,
                    updatedAt: new Date()
                });
                showToast(currentStatus ? 'Article marquÃ© indisponible' : 'Article marquÃ© disponible', 'info');
                loadMenu();
            } catch (e) {
                showToast('Erreur', 'error');
            }
        };

        document.getElementById('itemForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const editId = document.getElementById('editId').value;
            const itemData = {
                category: document.getElementById('category').value,
                categoryAr: document.getElementById('categoryAr').value,
                nameFr: document.getElementById('nameFr').value,
                nameAr: document.getElementById('nameAr').value,
                price: parseFloat(document.getElementById('price').value),
                available: document.getElementById('available').value === 'true',
                updatedAt: new Date()
            };

            try {
                if (editId) {
                    await updateDoc(doc(db, "menu", editId), itemData);
                    showToast('Article modifiÃ©', 'success');
                } else {
                    itemData.createdAt = new Date();
                    await addDoc(collection(db, "menu"), itemData);
                    showToast('Article ajoutÃ©', 'success');
                }
                closeModal();
                loadMenu();
            } catch (err) {
                showToast('Erreur: ' + err.message, 'error');
            }
        });

        /**
         * âš¡ Bolt: Batch restoration
         * Optimization: Uses Firestore writeBatch instead of individual addDoc calls in a loop.
         * Impact: Reduces network requests from N to 1.
         * Result: Significantly faster restoration and improved reliability.
         */
        async function restoreDefaults() {
            const defaults = [
                { category: "CafÃ©s", categoryAr: "Ø§Ù„Ù‚Ù‡ÙˆØ©", nameFr: "Express / Demi / AllongÃ©", nameAr: "Ø¥ÙƒØ³Ø¨Ø±ÙŠØ³Ùˆ / Ø¯Ù…ÙŠ / Ø£Ù„ÙˆÙ†Ø¬ÙŠ", price: 2.5, available: true },
                { category: "CafÃ©s", categoryAr: "Ø§Ù„Ù‚Ù‡ÙˆØ©", nameFr: "Cappuccino / Americano", nameAr: "ÙƒØ§Ø¨ÙˆØªØ´ÙŠÙ†Ùˆ / Ø£Ù…Ø±ÙŠÙƒØ§Ù†Ùˆ", price: 2.8, available: true },
                { category: "CafÃ©s", categoryAr: "Ø§Ù„Ù‚Ù‡ÙˆØ©", nameFr: "Direct", nameAr: "Ù‚Ù‡ÙˆØ© Ø¯ÙŠØ±ÙŠÙƒØª", price: 3.2, available: true },
                { category: "CafÃ©s", categoryAr: "Ø§Ù„Ù‚Ù‡ÙˆØ©", nameFr: "SpÃ©cial", nameAr: "Ù‚Ù‡ÙˆØ© Ø®Ø§ØµØ© (Ø³Ø¨Ø³ÙŠØ§Ù„)", price: 3.5, available: true },
                { category: "Boissons FraÃ®ches", categoryAr: "Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø¨Ø§Ø±Ø¯Ø©", nameFr: "Jus Frais", nameAr: "Ø¹ØµÙŠØ± Ø·Ø§Ø²Ø¬", price: 4, available: true },
                { category: "Boissons FraÃ®ches", categoryAr: "Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø¨Ø§Ø±Ø¯Ø©", nameFr: "Citronnade", nameAr: "Ù„ÙŠÙ…ÙˆÙ†Ø§Ø¶Ø©", price: 3, available: true },
                { category: "Boissons FraÃ®ches", categoryAr: "Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø¨Ø§Ø±Ø¯Ø©", nameFr: "Citronnade Amande", nameAr: "Ù„ÙŠÙ…ÙˆÙ†Ø§Ø¶Ø© Ø¨Ø§Ù„Ù„ÙˆØ²", price: 5, available: true },
                { category: "Boissons FraÃ®ches", categoryAr: "Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø¨Ø§Ø±Ø¯Ø©", nameFr: "Mojito", nameAr: "Ù…ÙˆÙ‡ÙŠØªÙˆ", price: 6, available: true },
                { category: "Viennoiseries", categoryAr: "Ù…Ø®Ø¨ÙˆØ²Ø§Øª", nameFr: "Snoopy / Croissant", nameAr: "Ø³Ù†ÙˆØ¨ÙŠ / ÙƒØ±ÙˆØ§Ø³ÙˆÙ†", price: 2.5, available: true },
                { category: "Viennoiseries", categoryAr: "Ù…Ø®Ø¨ÙˆØ²Ø§Øª", nameFr: "PÃ¢tÃ©", nameAr: "Ø¨Ø§ØªÙŠ", price: 2, available: true },
                { category: "ThÃ©", categoryAr: "Ø§Ù„Ø´Ø§ÙŠ", nameFr: "ThÃ©", nameAr: "Ø´Ø§ÙŠ", price: 2, available: true },
                { category: "ThÃ©", categoryAr: "Ø§Ù„Ø´Ø§ÙŠ", nameFr: "ThÃ© Amande", nameAr: "Ø´Ø§ÙŠ Ø¨Ø§Ù„Ù„ÙˆØ²", price: 4, available: true },
                { category: "Chicha & Girac", categoryAr: "Ø´ÙŠØ´Ø© ÙˆØ¬ÙŠØ±Ø§Ùƒ", nameFr: "Chicha Menthe", nameAr: "Ø´ÙŠØ´Ø© Ù†Ø¹Ù†Ø§Ø¹", price: 4, available: true },
                { category: "Chicha & Girac", categoryAr: "Ø´ÙŠØ´Ø© ÙˆØ¬ÙŠØ±Ø§Ùƒ", nameFr: "Chicha Cocktail", nameAr: "Ø´ÙŠØ´Ø© ÙƒÙˆÙƒØªÙŠÙ„", price: 4.5, available: true },
                { category: "Chicha & Girac", categoryAr: "Ø´ÙŠØ´Ø© ÙˆØ¬ÙŠØ±Ø§Ùƒ", nameFr: "Chicha Vide", nameAr: "Ø´ÙŠØ´Ø© ÙØ§Ø±ØºØ©", price: 3, available: true },
                { category: "Chicha & Girac", categoryAr: "Ø´ÙŠØ´Ø© ÙˆØ¬ÙŠØ±Ø§Ùƒ", nameFr: "Girac (M)", nameAr: "Ø¬ÙŠØ±Ø§Ùƒ (M)", price: 3.5, available: true },
                { category: "Chicha & Girac", categoryAr: "Ø´ÙŠØ´Ø© ÙˆØ¬ÙŠØ±Ø§Ùƒ", nameFr: "Girac (XL)", nameAr: "Ø¬ÙŠØ±Ø§Ùƒ (XL)", price: 4.5, available: true },
                { category: "Chicha & Girac", categoryAr: "Ø´ÙŠØ´Ø© ÙˆØ¬ÙŠØ±Ø§Ùƒ", nameFr: "Girac (XXL)", nameAr: "Ø¬ÙŠØ±Ø§Ùƒ (XXL)", price: 5.5, available: true },
                { category: "Eaux & Soft", categoryAr: "Ù…ÙŠØ§Ù‡ ÙˆÙ…Ø´Ø±ÙˆØ¨Ø§Øª ØºØ§Ø²ÙŠØ©", nameFr: "Eau 1.5 L", nameAr: "Ù…Ø§Ø¡ 1.5 Ù„", price: 2, available: true },
                { category: "Eaux & Soft", categoryAr: "Ù…ÙŠØ§Ù‡ ÙˆÙ…Ø´Ø±ÙˆØ¨Ø§Øª ØºØ§Ø²ÙŠØ©", nameFr: "Eau 0.5 L", nameAr: "Ù…Ø§Ø¡ 0.5 Ù„", price: 1, available: true },
                { category: "Eaux & Soft", categoryAr: "Ù…ÙŠØ§Ù‡ ÙˆÙ…Ø´Ø±ÙˆØ¨Ø§Øª ØºØ§Ø²ÙŠØ©", nameFr: "Canette", nameAr: "ÙƒØ§Ù†Ø§Øª", price: 2.5, available: true }
            ];
            try {
                const batch = writeBatch(db);
                for (const item of defaults) {
                    const newDocRef = doc(collection(db, "menu"));
                    batch.set(newDocRef, { ...item, createdAt: new Date() });
                }
                await batch.commit();
                showToast('Menu restaurÃ© avec succÃ¨s', 'success');
                loadMenu();
            } catch (e) {
                console.error(e);
                showToast('Erreur de restauration', 'error');
            }
        }
    </script>
</body>

</html>